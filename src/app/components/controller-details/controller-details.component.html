<div class="controller-container">
  <div class="controller-header">
    <div class="header-main">
      <div class="title-section border: 1px solid red;">
        <span class="status-indicator">
          <i [class.online]="controller?.status === 'online'" [class.offline]="controller?.status !== 'online'"></i>
        </span>
        <div class="controller-info">
          <h2>{{ controller?.name }}</h2>
          <span
            class="detail"
            *ngIf="controller?.status !== 'online'"
            >Last seen: {{ controller?.lastSeen | date: 'dd.MM.yyyy HH:mm:ss' }}</span
          >
        </div>
      </div>
      <div class="action-buttons">
        <div>
          <button class="settings-dropdown" (click)="showUploadConfirm = true">
            <img src="assets/icons/arrow-up.svg" width="28" height="28" alt="Upload" />  
          </button>
        </div>
        <div>          
          <button class="settings-btn" [routerLink]="['/controller', controller?.mac, 'settings']">
            <img src="assets/icons/settings-icon.svg" width="28" height="28" alt="Settings" />  
          </button>
        </div>
        <div class="settings-dropdown" [class.open]="actionsMenuOpen" (mouseleave)="actionsMenuOpen = false">
          <button class="settings-btn" (click)="toggleActionsMenu($event)">
            <img src="assets/icons/dots.png" width="28" height="28" alt="Actions" />
          </button>
          <ul class="dropdown-menu" *ngIf="actionsMenuOpen">
            <li (click)="onMenuInfo()">Info</li>
            <li (click)="onMenuReboot()">Reboot</li>
            <li (click)="onMenuUpdate()">Update</li>
            <li (click)="onMenuLogs()">Logs</li>            
            <li (click)="onMenuDelete()">!!!Delete!!!</li>            
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Tabs -->
  <div class="mobile-tabs">
    <button class="tab-button" [class.active]="activeTab === 'outputs'" (click)="setActiveTab('outputs')">
      Outputs
    </button>
    <button class="tab-button" [class.active]="activeTab === 'inputs'" (click)="setActiveTab('inputs')">
      Inputs
    </button>
    <button class="tab-button" [class.active]="activeTab === 'buttons'" (click)="setActiveTab('buttons')">
      Buttons
    </button>
  </div>

  <!-- Desktop View -->
  <div class="desktop-view">
    <h3 class="section-title">Outputs</h3>

    <div class="outputs-container">
      <ng-container *ngFor="let slaveGroup of outputsBySlaveGroups | keyvalue; trackBy: trackByGroupKey">
        <div class="slave-divider" *ngIf="slaveGroup.key !== '0'">
          <span class="slave-label">Slave ID: {{ slaveGroup.key }}</span>
        </div>
        <app-output-card *ngFor="let output of slaveGroup.value; trackBy: trackByOutput"
                        [output]="output"
                        [ngClass]="output.state"
                        [mac]="controller?.mac">
        </app-output-card>
      </ng-container>
    </div>

    <!-- <div class="outputs-container">
      <ng-container *ngFor="let slaveGroup of getOutputsBySlaveId() | keyvalue">
        <div class="slave-divider" *ngIf="slaveGroup.key !== '0'">
          <span class="slave-label">Slave ID: {{ slaveGroup.key }}</span>
        </div>
        <app-output-card *ngFor="let output of slaveGroup.value" 
                         [output]="output" 
                         [mac]="controller?.mac">
        </app-output-card>
      </ng-container>
    </div> -->

    <h3 class="section-title">Inputs</h3>
    <div class="inputs-container">
      <ng-container *ngFor="let slaveGroup of getInputsBySlaveId() | keyvalue">
        <div class="slave-divider" *ngIf="slaveGroup.key !== '0'">
          <span class="slave-label">Slave ID: {{ slaveGroup.key }}</span>
        </div>
        <app-input-card *ngFor="let input of slaveGroup.value"
                        [input]="input" 
                        [mac]="controller?.mac">
        </app-input-card>
      </ng-container>
    </div>

    <h3 class="section-title">Buttons</h3>
    <div class="buttons-container">
      <app-button-card *ngFor="let input of findButtons(controller?.io.inputs)"
                       [input]="input" 
                       [mac]="controller?.mac">
      </app-button-card>
    </div>
  </div>

  <!-- Mobile View -->
  <div class="mobile-view">
    <div class="tab-content" 
         [ngClass]="{
           'active': activeTab === 'outputs',
           'slide-right': getTabAnimationClass('outputs') === 'slide-right',
           'slide-left': getTabAnimationClass('outputs') === 'slide-left'
         }">
      <div class="outputs-container">
        <ng-container *ngFor="let slaveGroup of getOutputsBySlaveId() | keyvalue; trackBy: trackByGroupKey">
          <div class="slave-divider" *ngIf="slaveGroup.key !== '0'">
            <span class="slave-label">Slave ID: {{ slaveGroup.key }}</span>
          </div>
          <app-output-card *ngFor="let output of slaveGroup.value; trackBy: trackByOutput" 
                           [output]="output" 
                           [ngClass]="output.state"
                           [mac]="controller?.mac">                           
          </app-output-card>
        </ng-container>
      </div>
    </div>

    <div class="tab-content" 
         [ngClass]="{
           'active': activeTab === 'inputs',
           'slide-right': getTabAnimationClass('inputs') === 'slide-right',
           'slide-left': getTabAnimationClass('inputs') === 'slide-left'
         }">

      <div class="inputs-container">
        <ng-container *ngFor="let slaveGroup of getInputsBySlaveId() | keyvalue">
          <div class="slave-divider" *ngIf="slaveGroup.key !== '0'">
            <span class="slave-label">Slave ID: {{ slaveGroup.key }}</span>
          </div>
          <app-input-card *ngFor="let input of slaveGroup.value"
                          [input]="input" 
                          [mac]="controller?.mac">
          </app-input-card>
        </ng-container>
      </div>
    </div>

    <div class="tab-content" 
         [ngClass]="{
           'active': activeTab === 'buttons',
           'slide-right': getTabAnimationClass('buttons') === 'slide-right',
           'slide-left': getTabAnimationClass('buttons') === 'slide-left'
         }">
      <div class="buttons-container">
        <app-button-card *ngFor="let input of findButtons(controller?.io.inputs)"
                         [input]="input" 
                         [mac]="controller?.mac">
        </app-button-card>
      </div>
    </div>
  </div>

  <!-- Info Popup -->
  <div class="popup-overlay" *ngIf="showInfoPopup" (click)="showInfoPopup = false">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Controller Information</h3>
        <button class="close-button" (click)="showInfoPopup = false">
          <img src="assets/icons/close.svg" width="20" height="20" alt="Close" />
        </button>
      </div>
      <div class="popup-body">
        <div class="status-info">
          <p><span>Name</span> <span>{{ controller?.name }}</span></p>
          <p><span>Description</span> <span>{{ controller?.description }}</span></p>
          <p><span>Version</span> <span>{{ controller?.version }}</span></p>
          <p><span>Free Memory</span> <span>{{ controller?.freeMemory }}</span></p>
          <p><span>Uptime</span> <span>{{ controller?.uptime }}</span></p>
          <p><span>Uptime Raw</span> <span>{{ controller?.uptimeRaw }}</span></p>
          <p><span>Current Date</span> <span>{{ controller?.curdate }}</span></p>
          <p><span>MAC Address</span> <span>{{ controller?.mac }}</span></p>
          <p><span>Ethernet IP</span> <span>{{ controller?.ethIP }}</span></p>
          <p><span>WiFi IP</span> <span>{{ controller?.wifiIP }}</span></p>
          <p><span>WiFi RSSI</span> <span>{{ controller?.wifiRSSI }}</span></p>
          <p><span>Reset Reason</span> <span>{{ controller?.resetReason }}</span></p>
        </div>
        <button class="action-buttons" (click)="showInfo()">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Logs Panel -->
  <div class="popup-overlay" *ngIf="showLogsPanel" (click)="showLogsPanel = false">
    <div class="popup-content" [class.expanded]="showLogsPanel" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Logs</h3>
        <button class="close-button" (click)="showLogsPanel = false">
          <img src="assets/icons/close.svg" width="20" height="20" alt="Close" />
        </button>
      </div>
      <div class="popup-body">
        <div class="status-info">          
          <button (click)="enableSendLogs()">Enable send logs</button>
          <button (click)="disableSendLogs()">Disable send logs</button>          
          <div class="logs-content">
            <pre [innerHTML]="logsText | ansiColor"></pre>
          </div>
        </div>
      </div>
    </div>    
  </div>
</div>

<!-- Диалог подтверждения Upload -->
<div class="popup-overlay" *ngIf="showUploadConfirm">
  <div class="modal-dialog">
    <div class="modal-title">Are you sure to upload config in controller?</div>
    <div class="modal-actions">
      <button (click)="confirmUpload()">Yes</button>
      <button (click)="cancelDialog()">No</button>
    </div>
  </div>
</div>

<!-- Диалог подтверждения Delete -->
<div class="popup-overlay" *ngIf="showDeleteConfirm">
  <div class="modal-dialog">
    <div class="modal-title">Are you sure to DELETE controller?</div>
    <div class="modal-actions">
      <button (click)="confirmDelete()">Yes</button>
      <button (click)="cancelDialog()">No</button>
    </div>
  </div>
</div>

<!-- Диалог подтверждения Reboot -->
<div class="popup-overlay" *ngIf="showRebootConfirm">
  <div class="modal-dialog">
    <div class="modal-title">Are you sure to reboot controller?</div>
    <div class="modal-actions">
      <button (click)="confirmReboot()">Yes</button>
      <button (click)="cancelDialog()">No</button>
    </div>
  </div>
</div>

<!-- Диалог подтверждения Update -->
<div class="popup-overlay" *ngIf="showUpdateConfirm">
  <div class="modal-dialog">
    <div class="modal-title">Confirm update (OTA)?</div>
    <div class="modal-actions">
      <button (click)="confirmUpdate()">Yes</button>
      <button (click)="cancelDialog()">No</button>
    </div>
  </div>
</div>