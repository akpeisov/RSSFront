
<button class="back-btn" [routerLink]="['/controller', mac]">Back</button>

Test mac {{mac}} {{config?.mac}}

<div *ngIf="config">

  <div class="settings-section">
    <h2>Network Settings</h2>
    <div class="settings-panel">
      <div class="modal-body">
        <div class="network-section">
          <h4>WiFi</h4>
          <label *ngIf="config.network.wifi">Enabled
            <input type="checkbox" [(ngModel)]="config.network.wifi.enabled" />
          </label>
          <div class="wifi-row" *ngIf="config.network.wifi && config.network.wifi.enabled">
            <label>SSID
              <input type="text" [(ngModel)]="config.network.wifi.ssid" />
            </label>
            <label>Password
              <input type="text" [(ngModel)]="config.network.wifi.pass" />
            </label>
          </div>
          <label *ngIf="config.network.wifi && config.network.wifi.enabled">DHCP
            <input type="checkbox" [(ngModel)]="config.network.wifi.dhcp" />
          </label>
          <div class="wifi-row" *ngIf="config.network.wifi && config.network.wifi.enabled && !config.network.wifi.dhcp">
            <label>IP
              <input type="text" mask="IP" [(ngModel)]="config.network.wifi.ip" />
            </label>
            <label>Netmask
              <input type="text" [(ngModel)]="config.network.wifi.netmask" />
            </label>
          </div>
          <div class="wifi-row" *ngIf="config.network.wifi && config.network.wifi.enabled && !config.network.wifi.dhcp">
            <label>Gateway
              <input type="text" [(ngModel)]="config.network.wifi.gateway" />
            </label>
            <label>DNS
              <input type="text" [(ngModel)]="config.network.wifi.dns" />
            </label>
          </div>
          <label *ngIf="config.network.wifi && config.network.wifi.enabled && !config.network.wifi.dhcp">DNS
            <input type="text" [(ngModel)]="config.network.wifi.dns" />
          </label>
        </div>
        <div class="network-section">
          <h4>Ethernet</h4>
          <label *ngIf="config.network.eth">Enabled
            <input type="checkbox" [(ngModel)]="config.network.eth.enabled" />
          </label>
          <label *ngIf="config.network.eth && config.network.eth.enabled">DHCP
            <input type="checkbox" [(ngModel)]="config.network.eth.dhcp" />
          </label>
            <div class="eth-row" *ngIf="config.network.eth && config.network.eth.enabled && !config.network.eth.dhcp">
              <label>IP
                <input type="text" [(ngModel)]="config.network.eth.ip" />
              </label>
              <label>Netmask
                <input type="text" [(ngModel)]="config.network.eth.netmask" />
              </label>
            </div>
            <div class="eth-row" *ngIf="config.network.eth && config.network.eth.enabled && !config.network.eth.dhcp">
              <label>Gateway
                <input type="text" [(ngModel)]="config.network.eth.gateway" />
              </label>
              <label>DNS
                <input type="text" [(ngModel)]="config.network.eth.dns" />
              </label>
            </div>
          <label *ngIf="config.network.eth && config.network.eth.enabled">Enable Reset
            <input type="checkbox" [(ngModel)]="config.network.eth.enableReset" />
          </label>
          <label *ngIf="config.network.eth && config.network.eth.enabled && config.network.eth.enableReset">Reset GPIO
            <input type="number" [(ngModel)]="config.network.eth.resetGPIO" />
          </label>
        </div>
        <div class="network-section">
          <h4>NTP</h4>
          <label>NTP Server
            <input type="text" [(ngModel)]="config.network.ntpServer" />
          </label>
          <label *ngIf="config.network.ntpServer">Time Zone
            <input type="text" [(ngModel)]="config.network.ntpTZ" />
          </label>
        </div>
        <div class="network-section">
          <h4>OTA</h4>
          <label>OTA URL
            <input type="text" [(ngModel)]="config.network.otaURL" />
          </label>
        </div>
        <div class="network-section">
          <h4>Cloud</h4>
          <label *ngIf="config.network.cloud">Enabled
            <input type="checkbox" [(ngModel)]="config.network.cloud.enabled" />
          </label>
          <label *ngIf="config.network.cloud && config.network.cloud.enabled">Address
            <input type="text" [(ngModel)]="config.network.cloud.address" />
          </label>
        </div>
        <div class="network-section">
          <h4>FTP</h4>
          <label *ngIf="config.network.ftp">Enabled
            <input type="checkbox" [(ngModel)]="config.network.ftp.enabled" />
          </label>
          <label *ngIf="config.network.ftp && config.network.ftp.enabled">User
            <input type="text" [(ngModel)]="config.network.ftp.user" />
          </label>
          <label *ngIf="config.network.ftp && config.network.ftp.enabled">Password
            <input type="text" [(ngModel)]="config.network.ftp.pass" />
          </label>
        </div>
    </div>
    <div class="error-message" *ngIf="formError">{{ formError }}</div>    
  </div>  

    
  <div class="settings-section">
    <h2>Modbus Settings</h2>
    <div class="settings-panel">
      <div class="modal-body">
        <label>Mode
          <select [(ngModel)]="config.modbus.mode">
            <option value="none">None</option>
            <option value="master">Master</option>
            <option value="slave">Slave</option>
          </select>
        </label>
        <div *ngIf="config.modbus.mode === 'master'">
          <label>Polling Time
            <input type="number" [(ngModel)]="config.modbus.pollingTime">
          </label>
          <label>Read Timeout
            <input type="number" [(ngModel)]="config.modbus.readTimeout">
          </label>
          <label>Max Retries
            <input type="number" [(ngModel)]="config.modbus.maxRetries">
          </label>
          <label>Action on same slave
            <input type="checkbox" [(ngModel)]="config.modbus.actionOnSameSlave">
          </label>
        </div>
        <div *ngIf="config.modbus.mode === 'slave'">
          <label>SlaveId
            <input type="number" [(ngModel)]="config.modbus.slaveId">
          </label>
          <label>Master
            <select [(ngModel)]="config.modbus.master">
              <option *ngFor="let ctrl of availableMaster" [value]="ctrl.mac">{{ ctrl.name }}</option>
            </select>
          </label>
        </div>						
      </div>
    </div>
  </div>

  <div class="settings-section">
    <h2>Scheduler</h2>
    <div class="settings-panel">
      <div class="modal-body">
        <label>Enabled
          <input type="checkbox" [(ngModel)]="config.scheduler.enabled"/>          
        </label>
        <div *ngFor="let task of config.scheduler.tasks; let i = index" class="scheduler-task">
          <div class="task-header">
            <label>Enabled
              <input type="checkbox" [(ngModel)]="task.enabled">
            </label>
            <label>Name
              <input type="text" [(ngModel)]="task.name">
            </label>
            <button type="button" (click)="config.scheduler.tasks.splice(i,1)">üóëÔ∏è</button>
          </div>
          <div class="task-fields">
            <label>Grace (—Å–µ–∫)
              <input type="number" [(ngModel)]="task.grace">
            </label>
            <label>–í—Ä–µ–º—è
              <input type="time"
                [value]="(task.time !== undefined ? ((task.time/60) | number:'2.0-0')+':' + ((task.time%60)<10 ? '0'+(task.time%60) : (task.time%60)) : '')"
                (change)="updateTaskTime(task, $any($event.target).value)"
                style="width:90px;"
                title="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è"
              >
            </label>
            <label>Done
              <input type="checkbox" [(ngModel)]="task.done">
            </label>
          </div>
          <div class="task-dow" style="display:flex;align-items:center;gap:8px;">
            <span>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏:</span>
            <ng-container *ngFor="let day of [0,1,2,3,4,5,6]">
              <label style="margin-bottom:0;">
                <input type="checkbox" [checked]="task.dow.includes(day)" (change)="toggleDow(task, day)">{{ ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'][day] }}
              </label>
            </ng-container>
          </div>
          <div class="task-actions">
            <span>–î–µ–π—Å—Ç–≤–∏—è:</span>
            <div *ngFor="let action of task.actions; let j = index" class="action-row">
              <label>Type
                <select [(ngModel)]="action.type">
                  <option value="output">output</option>
                  <option value="input">input</option>
                </select>
              </label>
              <label>Action
                <select [(ngModel)]="action.action">
                  <option *ngIf="action.type === 'output'" value="on">on</option>
                  <option *ngIf="action.type === 'output'" value="off">off</option>
                  <option *ngIf="action.type === 'input'" value="toggle">toggle</option>
                  <option *ngIf="action.type === 'input'" value="longpress">longpress</option>
                </select>
              </label>
              <label *ngIf="action.type === 'output'">Output
                <select [(ngModel)]="action.output">
                  <option *ngFor="let out of config?.io?.outputs; let oi = index" [value]="oi">{{ out.name || ('Output '+oi) }}</option>
                </select>
              </label>
              <label *ngIf="action.type === 'input'">Input
                <select [(ngModel)]="action.input">
                  <option *ngFor="let inp of config?.io?.inputs; let ii = index" [value]="ii">{{ inp.name || ('Input '+ii) }}</option>
                </select>
              </label>
              <button type="button" (click)="task.actions.splice(j,1)">üóëÔ∏è</button>
            </div>
            <button type="button" (click)="task.actions.push({action:'on',type:'output',output:0})">+ –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</button>
          </div>
        </div>
        <button type="button" (click)="config.scheduler.tasks.push({name:'',grace:0,time:0,enabled:true,dow:[0,0,0,0,0,0,0],done:false,actions:[]})">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>
  </div>      

</div>

<div class="modal-actions">
  <button (click)="saveConfig()">Save</button>
</div> 
